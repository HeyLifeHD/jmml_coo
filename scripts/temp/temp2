library(RnBeads)

#load bock rnbeads set (merged)
#tar icgc/dkfzlsdf/analysis/C010/jmmlc_pbat/data/Bock_data/xfvz prog_v08_merged_rnbSet.tar.gz 
rnb_set <- load.rnb.set(file.path("icgc/dkfzlsdf/analysis/C010/jmmlc_pbat/data/Bock_data", "prog_v08_merged_rnbSet") )

#extract data
pheno <- pheno(rnb_set)
meth<-meth(rnb_set,"sites", row.names=FALSE)
anno<- annotation(rnb_set,"sites")
cov <- covg(rnb_set, "sites")
write.table(pheno[,1:11], file.path("icgc/dkfzlsdf/analysis/C010/jmmlc_pbat/data/Bock_data/", "sample_anno.txt"), sep="\t", row.names=FALSE, col.names=TRUE, quote=FALSE)
#export as bedgraph
for(i in colnames(meth)){
    temp <- anno[,1:3]
    temp$beta <- meth[,i]*100
    temp$M <- meth[,i]*cov[,i]
    temp$U <- cov[,i] - meth[,i]
    temp <- temp[complete.cases(temp),]
    write.table(temp , file.path("icgc/dkfzlsdf/analysis/C010/jmmlc_pbat/data/Bock_data/bedgraph_merged", paste0(i, ".bedGraph")), sep="\t", row.names=FALSE, quote=FALSE, col.names=FALSE)
}
#create methrix object
#libraries
library(methrix)
library(BSgenome.Hsapiens.UCSC.hg19)
library(dplyr)
#directories
odcf.dir <- "icgc/dkfzlsdf/analysis/C010/jmmlc_pbat/data/Bock_data/bedgraph_merged/"
output.dir <- "/home/heyj/omics/groups/OE0219/internal/jmmlc_pbat/data/odcf_md/analysis/"

#load reference CpGs
hg19_cpgs = methrix::extract_CPGs(ref_genome = "BSgenome.Hsapiens.UCSC.hg19")
bdg_PBAT_files = dir(path = odcf.dir , recursive=TRUE,pattern = "bedGraph$", full.names = TRUE)

#prepare sample sheet
#PBAT
pheno <- read.table(file.path("icgc/dkfzlsdf/analysis/C010/jmmlc_pbat/data/Bock_data/", "sample_anno.txt"), sep="\t", header=TRUE)
pheno$bedFile <- NULL
rownames(pheno) <- pheno$sampleName

#read begraphs
meth = methrix::read_bedgraphs(files = bdg_PBAT_files[1:3], ref_cpgs = hg19_cpgs, 
    chr_idx = 1, start_idx = 2, beta_idx=4 ,M_idx = 5, U_idx = 6,
    stranded = TRUE, collapse_strands = TRUE,
    coldata=pheno[1:3,],
    n_threads=3#, h5=TRUE, h5_dir=file.path(output.dir, "190923_methrix")
    )
saveRDS(meth, file.path(output.dir ,"methrix",  "methrix_bock_merged.rds"))
